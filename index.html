<!doctype html>
<html lang="nl" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BJC bestellen</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script>
    // Check if library is loaded
    window.addEventListener('load', () => {
      if (typeof Html5Qrcode === 'undefined') {
        console.error('HTML5-QRCode library niet geladen!');
      }
    });
  </script>
  <style>
    :root {
      --bg: #2b2d35;
      --panel: #171a21;
      --muted: #a0a8b8;
      --text: #e7ebf3;
      --accent: #7aa2f7;
      --ok: #8bd5ca;
      --warn: #f5a97f;
      --danger: #ed8796;
      --border: #2a2f3a;
    }
    html, body {
      margin:0; padding:0; background:var(--bg); color:var(--text); font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    *, *::before, *::after { box-sizing: border-box; }
    .wrap { max-width: 1100px; margin: 24px auto 56px; padding: 0 16px; }
    .header { display:flex; align-items:center; justify-content:center; gap:20px; margin-bottom:20px; padding:16px; background:var(--panel); border:1px solid var(--border); border-radius:14px; }
    .logo { display:flex; align-items:center; justify-content:center; gap:24px; flex: 0 0 auto; padding:8px 16px; background:rgba(122, 162, 247, 0.05); border-radius:10px; }
    .logo img { height: 120px !important; width:auto !important; max-width:none !important; object-fit:contain; filter: brightness(1.1) contrast(1.05); border-radius:12px; display:block !important; vertical-align:middle; }
    .logo img:first-child { max-width: 200px !important; filter: grayscale(100%) brightness(0.9) contrast(1.1) hue-rotate(80deg) saturate(0.5); }
    .logo img:last-child { max-width: 150px !important; }
    h1 { font-size: 20px; margin:0; letter-spacing:.4px; }
    .sub { color:var(--muted); font-size:12px; margin-top:2px; }
    .bar { margin-bottom: 20px; display: grid; grid-template-columns: 1.3fr 1fr; gap: 16px; }
    .search-container { display:flex; flex-direction:column; gap:8px; grid-column: 1 / -1; }
    .search { width:100%; background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px; display:flex; gap:10px; align-items:center; position:relative; }
    .btn-clear-top { width:100%; }
    .search input { flex:1; background:transparent; border:none; color:var(--text); outline:none; font-size:14px; }
    .qr-btn { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:10px 12px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:20px; transition:background 0.2s; }
    .qr-btn:hover { background:#1d2230; }
    .qr-btn-inline { background:transparent; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:4px; color:var(--muted); transition:color 0.2s; margin-left:4px; }
    .qr-btn-inline:hover { color:var(--accent); }
    .qr-btn-inline svg { width:20px; height:20px; }
    .qr-modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:1000; align-items:center; justify-content:center; flex-direction:column; }
    .qr-modal.active { display:flex; }
    .qr-scanner-container { background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:20px; max-width:95vw; max-height:95vh; width:90vw; position:relative; display:flex; flex-direction:column; align-items:center; }
    .qr-scanner-container #qr-reader { width:100%; max-width:100%; }
    .qr-close { position:absolute; top:10px; right:10px; background:var(--danger); color:white; border:none; border-radius:8px; padding:10px 16px; cursor:pointer; font-size:16px; font-weight:600; z-index:1001; box-shadow: 0 2px 8px rgba(0,0,0,0.5); }
    .qr-close:hover { opacity:0.9; transform: scale(1.05); }
    .pill { font-size:12px; padding:8px 10px; border:1px dashed var(--border); color:var(--muted); border-radius:10px; }
    .hidden { display:none!important; }
    .grid { display:grid; grid-template-columns: 1.3fr 1fr; gap:16px; margin-top:12px; margin-bottom: 20px; }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px; margin-bottom: 16px; }
    .panel h2 { margin:0 0 8px; font-size:14px; color:var(--muted); font-weight:600; }
    .results { max-height: 62vh; overflow:auto; border-radius:10px; }
    .row { display:grid; grid-template-columns: 110px 1fr 90px 120px 90px; gap:10px; padding:10px; border-bottom:1px solid var(--border); align-items:center; }
    .row:hover { background:#1d2230; }
    .head { position:sticky; top:0; background:#151923; z-index:1; border-bottom:1px solid var(--border); }
    .muted { color:var(--muted); }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .btn { border:1px solid var(--border); background:#1c2130; color:var(--text); padding:7px 9px; border-radius:10px; cursor:pointer; }
    .btn:disabled { opacity:.4; cursor:not-allowed; }
    .btn-primary { background:linear-gradient(180deg, #2a3b66, #1c2a4e); color:#eaf2ff; border-color:#2d3b57; }
    .qty { width:70px; background:#0f1320; border:1px solid var(--border); color:var(--text); border-radius:8px; padding:6px 8px; }
    .cart-total { margin-top:12px; padding:12px; background:#1a1f2e; border:1px solid var(--border); border-radius:10px; display:flex; justify-content:space-between; align-items:center; font-weight:600; }
    .cart-total-label { color:var(--muted); font-size:14px; }
    .cart-total-price { color:var(--text); font-size:16px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .tfoot { display:flex; justify-content:space-between; align-items:center; padding-top:8px; gap:10px; flex-wrap:wrap; }
    .badgelite { font-size:11px; padding:6px 8px; color:var(--muted); border:1px solid var(--border); border-radius:10px; }
    .copy { background:#112233; }
    .danger { color:var(--danger); }
    .ok { color:var(--ok); }
    a { color: var(--accent); text-decoration: none; }
  
@media (max-width: 768px) {
  .wrap { margin: 16px auto 48px; }
  .header { flex-direction: column; align-items: center; gap: 12px; padding: 12px; }
  .logo { flex: 0 0 auto; max-width: 100%; width: 100%; gap: 16px; padding: 8px 12px; justify-content: center; }
  .logo img { height: 100px !important; width:auto; max-width:none; border-radius: 10px; display:block; }
  .logo img:first-child { max-width: 180px; filter: grayscale(100%) brightness(0.9) contrast(1.1) hue-rotate(80deg) saturate(0.5); }
  .logo img:last-child { max-width: 130px; }
  .search-container { order: 1; }
  .qr-scanner-container { width: 95vw; max-width: 95vw; padding: 15px; }
  .qr-scanner-container #qr-reader { max-width: 100%; width: 100%; }
  .qr-close { z-index: 1001; }
  .grid { grid-template-columns: 1fr; }
  .panel { padding: 14px 12px; }
  .results { max-height: none; }
  .row { grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 4px 10px; padding: 8px 10px; }
  .row.head { display: none; }
  #results .row.item {
    grid-template-columns: minmax(0, 1fr) auto;
    grid-template-areas:
      "art price"
      "desc price"
      "unit controls";
    align-items: center;
    gap: 4px 12px;
  }
  #results .row.item > div:nth-child(1) { grid-area: art; }
  #results .row.item > div:nth-child(2) { grid-area: desc; }
  #results .row.item > div:nth-child(3) { grid-area: price; justify-self: end; }
  #results .row.item > div:nth-child(4) { grid-area: unit; font-size: 11px; color: var(--muted); }
  #results .row.item > div:nth-child(5) { grid-area: controls; display: flex; gap: 6px; justify-self: end; }
  #cart .row.item {
    grid-template-columns: minmax(0, 1fr) auto;
    grid-template-areas:
      "art qty"
      "desc action"
      "price action";
    align-items: center;
    gap: 4px 12px;
  }
  #cart .row.item > div:nth-child(1) { grid-area: art; }
  #cart .row.item > div:nth-child(2) { grid-area: desc; }
  #cart .row.item > div:nth-child(3) { grid-area: qty; font-weight:600; justify-self: end; }
  #cart .row.item > div:nth-child(4) { grid-area: price; font-size: 12px; color: var(--muted); }
  #cart .row.item > div:nth-child(5) { grid-area: action; justify-self: end; }
  .qty { width: 90px; }
  .tfoot { flex-direction: column; align-items: stretch; }
  .tfoot > span { align-self: flex-start; }
}

</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="logo">
        <img src="BJC.png" alt="BJC Logo" />
        <img src="Oet logo.jpg" alt="Oet Logo" />
      </div>
      <div>
        <h1>BJC bestellen</h1>
      </div>
    </div>

    <div class="bar">
      <div class="search-container">
        <div class="search">
          <span class="muted">ðŸ”Ž</span>
          <input id="q" type="text" placeholder="Zoek op omschrijving of artikelnummerâ€¦ (min. 2 tekens)"/>
          <button id="qrBtn" class="qr-btn-inline" title="Scan QR-code">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="5" height="5" rx="1"/>
              <rect x="16" y="3" width="5" height="5" rx="1"/>
              <rect x="3" y="16" width="5" height="5" rx="1"/>
              <path d="M8 8h8M8 16h8M16 8v8"/>
              <rect x="10" y="10" width="4" height="4"/>
            </svg>
          </button>
        </div>
        <div class="pill">Resultaten verschijnen zodra je begint te typen</div>
        <button id="clearTop" class="btn btn-clear-top" disabled>Wissen</button>
      </div>
    </div>

    <div id="qrModal" class="qr-modal">
      <div class="qr-scanner-container">
        <button id="qrClose" class="qr-close">Sluiten</button>
        <div id="qr-reader" style="width: 100%;"></div>
        <div id="qr-status" style="color: var(--text); text-align: center; margin-top: 10px; font-size: 14px; min-height: 20px; font-weight: 500;">Camera wordt gestart...</div>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h2>Zoekresultaten</h2>
        <div id="results" class="results">
          <div class="row head muted">
            <div class="code">Art.nr</div>
            <div>Omschrijving</div>
            <div class="code">Netto/VE</div>
            <div>VE</div>
            <div>Actie</div>
          </div>
          <div id="empty" class="muted" style="padding:12px;">Typ minimaal 2 tekens om resultaten te zien.</div>
        </div>
        <div class="tfoot">
          <span id="count" class="badgelite">0 resultaten</span>
          <button id="clear" class="btn" disabled>Wissen</button>
        </div>
      </div>

      <div class="panel">
        <h2>Bestellijst</h2>
        <div id="cart" class="results">
          <div class="row head muted">
            <div class="code">Art.nr</div>
            <div>Omschrijving</div>
            <div class="code">Aantal</div>
            <div class="code">Netto</div>
            <div>Actie</div>
          </div>
          <div id="cartEmpty" class="muted" style="padding:12px;">Nog geen items toegevoegd.</div>
        </div>
        <div class="tfoot">
          <span id="cartCount" class="badgelite">0 items</span>
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="emailMike" class="btn btn-primary" disabled>Mail naar werkplaats</button>
            <button id="copy" class="btn copy" disabled>Kopieer voor WhatsApp</button>
            <button id="reset" class="btn danger" disabled>Leeg lijst</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer style="text-align: center; color: var(--muted); font-size: 11px; padding: 16px 0; margin-top: 32px;">
    <div id="buildInfo">Last build 17-11-2025 By MLelieveld</div>
  </footer>

  <!-- 
    DATA SECTIE - VUL HIER JE PRODUCTDATA IN
    Vervang de lege array [] hieronder met je eigen productdata in JSON formaat.
    Voorbeeld formaat:
    [
      {
        "Artikelnummer": 123456,
        "Artikelomschrijving": "Product naam",
        "Brutoprijs": 10.00,
        "Kortingpercentage": 20,
        "Nettoprijs": 8.00,
        "Verkoopprijseenheid": "stuk",
        "ean-nummer": 1234567890123
      },
      ...
    ]
  -->
  <script id="DATA" type="application/json">[]</script>

  <script>
  const DATA = JSON.parse(document.getElementById('DATA').textContent.trim());

  const $q = document.getElementById('q');
  const $results = document.getElementById('results');
  const $empty = document.getElementById('empty');
  const $count = document.getElementById('count');
  const $clear = document.getElementById('clear');
  const $clearTop = document.getElementById('clearTop');

  const $cart = document.getElementById('cart');
  const $cartEmpty = document.getElementById('cartEmpty');
  const $cartCount = document.getElementById('cartCount');
  const $emailMike = document.getElementById('emailMike');
  const $copy = document.getElementById('copy');
  const $reset = document.getElementById('reset');
  const $qrBtn = document.getElementById('qrBtn');
  const $qrModal = document.getElementById('qrModal');
  const $qrClose = document.getElementById('qrClose');
  const $qrReader = document.getElementById('qr-reader');

  let cart = [];
  let qrScanner = null;
  let qrScanBlocked = false;
  let qrScanDelay = 2000; // 2 seconden vertraging
  let qrCountdownInterval = null;

  function fmt(n) { return (n==null||n==='')?'-':(typeof n==='number'? n.toLocaleString('nl-NL', {minimumFractionDigits:2, maximumFractionDigits:2}) : n); }
  function fmtKomdex(n) {
    if (n == null || n === '') return '0';
    const num = Number(n);
    if (Number.isNaN(num)) return '0';
    return num.toLocaleString('nl-NL', {minimumFractionDigits:0, maximumFractionDigits:2});
  }
  function safe(str) { return (str||'').toString(); }

  function search(q) {
    if (!q) return [];
    q = q.toString().replace(/[^\w\s\-\/]/g, '').trim();
    if (q.length < 2) return [];
    const isNum = /^[0-9]+$/.test(q);
    const needle = q.toLowerCase();
    const out = [];
    for (const it of DATA) {
      const nr = safe(it["Artikelnummer"]);
      const oms = safe(it["Artikelomschrijving"]);
      if (!nr && !oms) continue;
      if (isNum) {
        if (nr && nr.toString().indexOf(q) !== -1) out.push(it);
      } else {
        if (oms.toLowerCase().indexOf(needle) !== -1) out.push(it);
      }
    }
    return out.slice(0, 400);
  }

  function renderResults(arr) {
    $results.querySelectorAll('.row.item').forEach(n => n.remove());
    if (arr.length === 0) {
      $empty.classList.remove('hidden');
      $count.textContent = '0 resultaten';
      $clear.disabled = true;
      $clearTop.disabled = true;
      return;
    }
    $empty.classList.add('hidden');
    $count.textContent = arr.length + ' resultaten';
    $clear.disabled = false;
    $clearTop.disabled = false;

    const frag = document.createDocumentFragment();
    for (const it of arr) {
      const row = document.createElement('div');
      row.className = 'row item';
      const art = safe(it["Artikelnummer"]);
      const oms = safe(it["Artikelomschrijving"]);
      const netto = it["Nettoprijs"];
      const korting = it["Kortingpercentage"];
      const ve = safe(it["Verkoopprijseenheid"]);
      row.innerHTML = `
        <div class="code">${art}</div>
        <div>${oms}</div>
        <div class="code">â‚¬ ${fmt(netto)}</div>
        <div>${ve||'-'}</div>
        <div style="display:flex; gap:6px; align-items:center;">
          <input class="qty" type="number" min="1" step="1" value="1" />
          <button class="btn btn-primary">Toevoegen</button>
        </div>
      `;
      const btn = row.querySelector('button');
      const qty = row.querySelector('input.qty');
      btn.addEventListener('click', () => addToCart({ art, oms, netto, ve, korting }, parseInt(qty.value||'1',10)));
      frag.appendChild(row);
    }
    $results.appendChild(frag);
  }

  function findInCart(art) {
    for (let i = 0; i < cart.length; i++) {
      if (cart[i].art === art) return i;
    }
    return -1;
  }

  function addToCart(item, aantal) {
    if (!aantal || aantal < 1) aantal = 1;
    const i = findInCart(item.art);
    if (i >= 0) cart[i].aantal += aantal;
    else cart.push({ ...item, aantal });
    renderCart();
  }

  function removeFromCart(art) {
    cart = cart.filter(x => x.art !== art);
    renderCart();
  }

  function renderCart() {
    $cart.querySelectorAll('.row.item').forEach(n => n.remove());
    $cart.querySelectorAll('.cart-total').forEach(n => n.remove());
    if (cart.length === 0) {
      $cartEmpty.classList.remove('hidden');
      $cartCount.textContent = '0 items';
      $emailMike.disabled = true;
      $copy.disabled = true;
      $reset.disabled = true;
      return;
    }
    $cartEmpty.classList.add('hidden');
    $cartCount.textContent = cart.length + ' items';
    $emailMike.disabled = false;
    $copy.disabled = false;
    $reset.disabled = false;

    const frag = document.createDocumentFragment();
    for (const it of cart) {
      const row = document.createElement('div');
      row.className = 'row item';
      row.innerHTML = `
        <div class="code">${it.art}</div>
        <div>${it.oms}</div>
        <div class="code">${it.aantal}</div>
        <div class="code">â‚¬ ${fmt(it.netto)}</div>
        <div><button class="btn danger">Verwijder</button></div>
      `;
      row.querySelector('button').addEventListener('click', () => removeFromCart(it.art));
      frag.appendChild(row);
    }
    $cart.appendChild(frag);

    // Bereken en toon totaalprijs
    const total = cart.reduce((sum, it) => sum + (it.aantal * it.netto), 0);
    const totalDiv = document.createElement('div');
    totalDiv.className = 'cart-total';
    totalDiv.innerHTML = `
      <span class="cart-total-label">Totaal:</span>
      <span class="cart-total-price">â‚¬ ${fmt(total)}</span>
    `;
    $cart.appendChild(totalDiv);
  }

  function mapUnit(raw) {
    const value = (raw || '').toString().trim();
    if (!value) return 'stk';
    const lower = value.toLowerCase();
    if (lower.indexOf('stuk') !== -1) return 'stk';
    if (lower.indexOf('stuks') !== -1) return 'stk';
    if (lower.indexOf('paar') !== -1) return 'paar';
    if (lower.indexOf('meter') !== -1) return 'mtr';
    if (lower.indexOf('rol') !== -1) return 'rol';
    if (lower.indexOf('doos') !== -1) return 'doos';
    if (lower.indexOf('set') !== -1) return 'set';
    if (lower.indexOf('blister') !== -1) return 'blister';
    if (lower.indexOf('pak') !== -1) return 'pak';
    if (lower.indexOf('zak') !== -1) return 'zak';
    return value;
  }

  function buildKomdexText() {
    const lines = cart.map(it => {
      const cols = [
        it.aantal,
        mapUnit(it.ve),
        '0',
        '0',
        it.art,
        it.oms,
        fmtKomdex(it.netto),
        fmtKomdex(it.korting ?? 0)
      ];
      return cols.join('\t');
    });
    return lines.join('\n');
  }

  function emailMike() {
    const txt = buildKomdexText();
    const subject = encodeURIComponent('Bestelling uit mobiele tool');
    const body = encodeURIComponent(txt.replace(/\r?\n/g, '\r\n'));
    const mailto = `mailto:werkplaats@vandenoetelaar-metaal.nl?subject=${subject}&body=${body}`;

    const link = document.createElement('a');
    link.href = mailto;
    link.style.display = 'none';
    document.body.appendChild(link);
    setTimeout(() => {
      link.click();
      document.body.removeChild(link);
    }, 0);
  }

  async function copyKomdex() {
    const txt = buildKomdexText();
    try {
      await navigator.clipboard.writeText(txt);
      $copy.textContent = 'Gekopieerd âœ”';
      setTimeout(() => $copy.textContent = 'Kopieer voor WhatsApp', 1200);
    } catch (e) {
      const ta = document.createElement('textarea');
      ta.value = txt; document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); document.body.removeChild(ta);
      $copy.textContent = 'Gekopieerd âœ”';
      setTimeout(() => $copy.textContent = 'Kopieer voor WhatsApp', 1200);
    }
  }

  function debounce(fn, ms) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; }
  const doSearch = debounce(() => { renderResults(search($q.value||'')); }, 130);

  // QR Code Scanner functionaliteit
  function startQRScanner() {
    const $qrStatus = document.getElementById('qr-status');
    
    if (typeof Html5Qrcode === 'undefined') {
      if ($qrStatus) $qrStatus.textContent = "Fout: QR-library niet geladen!";
      alert('QR-code scanner library niet geladen. Ververs de pagina.');
      stopQRScanner();
      return;
    }

    if (qrScanner) {
      try {
        qrScanner.stop().then(() => {
          qrScanner.clear();
        }).catch(() => {});
      } catch(e) {}
      qrScanner = null;
    }

    // Leeg de reader div eerst
    $qrReader.innerHTML = '';

    try {
      if ($qrStatus) $qrStatus.textContent = "Camera wordt gestart...";
      
      qrScanner = new Html5Qrcode("qr-reader");
      const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0,
        disableFlip: false
      };

      if ($qrStatus) $qrStatus.textContent = "Vraag camera toegang aan...";

      qrScanner.start(
        { facingMode: "environment" }, // Gebruik achterste camera op mobiel
        config,
        (decodedText, decodedResult) => {
          // QR-code succesvol gescand
          if (qrScanBlocked) return; // Negeer scans tijdens vertraging
          
          console.log("QR-code gescand:", decodedText);
          
          // Blokkeer scanner tijdelijk
          qrScanBlocked = true;
          
          // Toon gescande code en start countdown
          if ($qrStatus) {
            $qrStatus.textContent = `âœ… QR-code gescand: ${decodedText}`;
            $qrStatus.style.color = 'var(--ok)';
          }
          
          $q.value = decodedText;
          doSearch();
          
          // Stop vorige countdown als die nog loopt
          if (qrCountdownInterval) {
            clearInterval(qrCountdownInterval);
          }
          
          // Countdown indicator
          let countdown = qrScanDelay / 1000;
          qrCountdownInterval = setInterval(() => {
            countdown--;
            if ($qrStatus && countdown > 0) {
              $qrStatus.textContent = `âœ… QR-code gescand! Sluit over ${countdown}s...`;
            } else {
              clearInterval(qrCountdownInterval);
              qrCountdownInterval = null;
              qrScanBlocked = false;
              // Sluit scanner automatisch na countdown
              stopQRScanner();
            }
          }, 1000);
        },
        (errorMessage) => {
          // Fout wordt genegeerd (scanner blijft proberen)
          // console.log("Scan error (negeer):", errorMessage);
        }
      ).then(() => {
        if ($qrStatus) $qrStatus.textContent = "Richt camera op QR-code...";
        console.log("QR scanner gestart");
      }).catch((err) => {
        console.error("QR scanner error:", err);
        let errorMsg = "Kan camera niet openen.";
        if (err.name === 'NotAllowedError') {
          errorMsg = "Camera toegang geweigerd. Geef toestemming in je browser instellingen.";
          if ($qrStatus) $qrStatus.textContent = "Camera toegang geweigerd";
        } else if (err.name === 'NotFoundError') {
          errorMsg = "Geen camera gevonden op dit apparaat.";
          if ($qrStatus) $qrStatus.textContent = "Geen camera gevonden";
        } else {
          if ($qrStatus) $qrStatus.textContent = "Fout: " + err.message;
        }
        alert(errorMsg);
        stopQRScanner();
      });
    } catch (err) {
      console.error("Error initializing scanner:", err);
      if ($qrStatus) $qrStatus.textContent = "Fout: " + err.message;
      alert("Fout bij initialiseren van QR-scanner: " + err.message);
      stopQRScanner();
    }
  }

  function stopQRScanner() {
    qrScanBlocked = false; // Reset blokkering
    if (qrCountdownInterval) {
      clearInterval(qrCountdownInterval);
      qrCountdownInterval = null;
    }
    if (qrScanner) {
      qrScanner.stop().then(() => {
        qrScanner.clear();
        qrScanner = null;
      }).catch((err) => {
        console.error("Error stopping scanner:", err);
        try {
          qrScanner.clear();
        } catch(e) {}
        qrScanner = null;
      });
    }
    // Leeg de reader div
    if ($qrReader) {
      $qrReader.innerHTML = '';
    }
    $qrModal.classList.remove('active');
  }

  $qrBtn.addEventListener('click', () => {
    console.log("QR knop geklikt");
    if (!$qrModal) {
      alert("QR modal element niet gevonden!");
      return;
    }
    $qrModal.classList.add('active');
    console.log("Modal geopend, start scanner...");
    setTimeout(() => {
      if (!$qrReader) {
        alert("QR reader element niet gevonden!");
        return;
      }
      startQRScanner();
    }, 300);
  });

  $qrClose.addEventListener('click', stopQRScanner);

  // Sluit modal bij klik buiten scanner
  $qrModal.addEventListener('click', (e) => {
    if (e.target === $qrModal) {
      stopQRScanner();
    }
  });

  $q.addEventListener('input', doSearch);
  $q.addEventListener('keyup', doSearch);
  $clear.addEventListener('click', () => { $q.value=''; renderResults([]); });
  $clearTop.addEventListener('click', () => { $q.value=''; renderResults([]); });
  $emailMike.addEventListener('click', emailMike);
  $copy.addEventListener('click', copyKomdex);
  $reset.addEventListener('click', () => { cart = []; renderCart(); });

  renderResults([]);
  renderCart();
  </script>
</body>
</html>
